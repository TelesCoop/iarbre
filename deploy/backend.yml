---
- name: Setup and launch django backend
  hosts: all
  vars:
    identity_file_path: "{{ backend_identity_file_path }}"
    repo: "{{ backend_repo }}"
    clone_path: "{{ project_dir }}/backend/"
    database_password: "{{ vault_database_password }}"
    django_settings_path: /etc/{{ organization_slug }}/{{ project_slug }}/settings.ini
    django_path: "{{ clone_path }}/back"
    working_dir: "{{ django_path }}"
    django_workers: 1
    database_backup:
      hour: 2
      minute: 0
    git_track_submodules: false
  handlers:
    - import_tasks: telescoop-deploy/handlers/nginx.yml
  tasks:
    - import_tasks: telescoop-deploy/tasks/create-https-certificate.yml
    - import_tasks: telescoop-deploy/tasks/setup-user-and-directories.yml
    - import_tasks: telescoop-deploy/tasks/setup-and-clone-git.yml
    - import_tasks: telescoop-deploy/tasks/install-python-venv.yml
    - name: Install and setup database for prod and preprod only
      block:
        - import_tasks: telescoop-deploy/tasks/install-database.yml
        - name: Install and setup postgis to postgresql
          block:
            - name: Install postgis
              apt:
                name:
                  - postgresql-14-postgis-3
            - name: Adds postgis extension to the database {{ project_slug }}
              community.postgresql.postgresql_ext:
                name: postgis
                login_db: "{{ project_slug }}"
              become: true
              become_user: postgres
          when: database_provider == "postgresql"
      when: dedicated_database == true
    - name: Create symbolic link from feature mvt_files to preprod mvt_files
      file:
        src: "{{ project_base_dir }}_preprod/backend/back/mvt_files"
        dest: "{{ django_path }}/mvt_files"
        state: link
      when: branch is defined
    - name: Use s3 backup on non-feature branch
      block:
        - name: Clear cache
          shell:
            cmd: "{{ project_slug }}-ctl clean_mvt_files && {{ project_slug }}-ctl clear_cache"
          when: clonecode.changed or force_update is defined

        - name: Load database and media
          shell:
            cmd: "{{ project_slug }}-ctl backup_db recover_db_and_media"
          when: clonecode.changed or force_update is defined
      when: branch is not defined
    - import_tasks: telescoop-deploy/tasks/install-and-update-django.yml
