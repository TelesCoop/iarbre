---
- name: Setup and launch django backend
  hosts: all
  vars:
    django_path: "{{ project_dir }}/backend/back"
  handlers:
    - import_tasks: telescoop-deploy/handlers/nginx.yml
  tasks:
    - import_tasks: telescoop-deploy/tasks/create-https-certificate.yml
    - import_tasks: telescoop-deploy/tasks/setup-user-and-directories.yml
    - import_tasks: telescoop-deploy/tasks/setup-and-clone-git.yml
      vars:
        identity_file_path: "{{ backend_identity_file_path }}"
        repo: "{{ backend_repo }}"
        git_track_submodules: false
        clone_path: "{{ django_path }}/../"
        branch: "{{ backend_branch }}"
    - import_tasks: telescoop-deploy/tasks/install-python-venv.yml
      vars:
        requirements: "{{ django_path }}/requirements.txt"
    - name: Install and setup database for prod and preprod only
      block:
        - import_tasks: telescoop-deploy/tasks/install-database.yml
          vars:
            database_password: "{{ vault_database_password }}"
      when: dedicated_database
    - name: Use preprod media on feature branch by default
      block:
        - name: Remove existing media directory on feature branches
          file:
            path: "{{ backend_media_path }}"
            state: absent
        - name: Create symbolic link from feature media to preprod media
          file:
            src: "{{ project_base_dir }}_preprod/backend/back/media"
            dest: "{{ backend_media_path }}"
            state: link
      when: not dedicated_database
    - import_tasks: telescoop-deploy/tasks/install-and-update-django.yml
      vars:
        django_settings_path: /etc/{{ organization_slug }}/{{ project_slug }}/settings.ini
        django_workers: 1
        dedicated_database: "{{ dedicated_database }}"
        allow_backup: false
        database_password: "{{ vault_database_password }}"
        # If you use custom template, do not name it settings.j2
        template_django_settings_name: "settings-custom.ini.j2"

    - name: Use s3 backup on non-feature branch (iarbre specific)
      block:
        - name: Clear cache
          shell:
            cmd: "{{ project_slug }}-ctl clean_mvt_files && {{ project_slug }}-ctl clear_cache"

        - name: Check if .db_recover_target exists
          stat:
            path: "{{ django_path }}/.db_recover_target"
          register: db_recover_target_file

        - name: Read database version from .db_recover_target
          slurp:
            src: "{{ django_path }}/.db_recover_target"
          register: db_recover_target_content
          when: db_recover_target_file.stat.exists

        - name: Set recover targets (from file or default to latest)
          set_fact:
            db_recover_target: "{{ (db_recover_target_content['content'] | b64decode | trim).split(',')[0] | trim if db_recover_target_file.stat.exists else 'latest' }}"
            media_recover_target: "{{ (db_recover_target_content['content'] | b64decode | trim).split(',')[1] | trim if db_recover_target_file.stat.exists else 'latest' }}"

        - name: Display recover targets
          debug:
            msg: "Using recover targets - db: {{ db_recover_target }}, media: {{ media_recover_target }}"

        - name: Load database and media
          shell:
            cmd: "{{ project_slug }}-ctl backup_db recover_db_and_media {{ db_recover_target }} {{ media_recover_target }}"

        - name: Run migrations with conflict handling
          shell: |
            {{ project_slug }}-ctl migrate || {
              echo "Migration failed, trying fake-initial"
              {{ project_slug }}-ctl migrate --fake-initial
              {{ project_slug }}-ctl migrate
            }
          become: true

      when: dedicated_database and (clonecode.changed or force_update is defined)
