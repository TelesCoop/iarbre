- name: Copy nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-enabled/{{ project_slug }}-showcase
    owner: root
    group: root
    mode: 0644
  notify:
    - reload nginx

- name: get latest docs code
  git:
    repo: "{{ frontend_repo }}"
    dest: "{{ docs_path }}/.."
    key_file: "{{ backend_identity_file_path }}"
    accept_hostkey: true
    force: true
    version: "{{ docs_branch }}"
  become_user: "{{ main_user }}"
  register: clonecode

- name: Install MkDocs and dependencies
  pip:
    name:
      - mkdocs
      - mkdocs-material
    executable: pip3
  become: true

- name: Build documentation
  command: make build
  args:
    chdir: "{{ docs_path }}"
  become_user: "{{ main_user }}"
  when: clonecode.changed or force_update is defined

- name: update docs static folder content
  synchronize:
    src: "{{ docs_path }}/site/"
    dest: "{{ docs_static_path }}/"
    rsync_opts:
      - "-a"
      - "--delete"
      - "--chown=www-data:www-data"
  delegate_to: "{{ inventory_hostname }}"
  when: clonecode.changed or force_update is defined

- name: Check if MkDocs site is available
  uri:
    url: "http://{{ main_hostname }}"
    status_code: 200
  register: site_status
  ignore_errors: true

- name: Fail if site is not accessible
  fail:
    msg: "Documentation site is not accessible!"
  when: site_status.status != 200
