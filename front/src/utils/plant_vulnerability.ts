import { PLANTABILITY_COLOR_MAP } from "./plantability"

// Bivariate color mapping for Plant Vulnerability
// Combines plantability (0-10) with vulnerability (1-9)
export const PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP: {
  [plantability: number]: { [vulnerability: number]: string }
} = {
  // Impossible (0-1) - Gray base with vulnerability tint
  0: {
    1: "#A8A8A8",
    2: "#A8A8A8",
    3: "#A8A8A8",
    4: "#A8A8A8",
    5: "#A8A8A8",
    6: "#A8A8A8",
    7: "#A8A8A8",
    8: "#A8A8A8",
    9: "#A8A8A8"
  },
  1: {
    1: "#A8A8A8",
    2: "#A8A8A8",
    3: "#A8A8A8",
    4: "#A8A8A8",
    5: "#A8A8A8",
    6: "#A8A8A8",
    7: "#A8A8A8",
    8: "#A8A8A8",
    9: "#A8A8A8"
  },

  // Very Constrained (2-3) - Brown base transitioning to red with high vulnerability
  2: {
    1: "#BF5A16",
    2: "#BF5A16",
    3: "#B85A1A",
    4: "#B8541E",
    5: "#B84E22",
    6: "#B84826",
    7: "#B8422A",
    8: "#B83C2E",
    9: "#B83632"
  },
  3: {
    1: "#BF5A16",
    2: "#BF5A16",
    3: "#B85A1A",
    4: "#B8541E",
    5: "#B84E22",
    6: "#B84826",
    7: "#B8422A",
    8: "#B83C2E",
    9: "#B83632"
  },

  // Constrained (4-5) - Yellow-orange base with vulnerability gradient
  4: {
    1: "#DDAD14",
    2: "#DDAD14",
    3: "#D8A518",
    4: "#D39D1C",
    5: "#CE9520",
    6: "#C98D24",
    7: "#C48528",
    8: "#BF7D2C",
    9: "#BA7530"
  },
  5: {
    1: "#DDAD14",
    2: "#DDAD14",
    3: "#D8A518",
    4: "#D39D1C",
    5: "#CE9520",
    6: "#C98D24",
    7: "#C48528",
    8: "#BF7D2C",
    9: "#BA7530"
  },

  // Neutral (6-7) - Light green base with vulnerability warming
  6: {
    1: "#A6CC4A",
    2: "#A6CC4A",
    3: "#A4C84E",
    4: "#A2C452",
    5: "#A0C056",
    6: "#9EBC5A",
    7: "#9CB85E",
    8: "#9AB462",
    9: "#98B066"
  },
  7: {
    1: "#A6CC4A",
    2: "#A6CC4A",
    3: "#A4C84E",
    4: "#A2C452",
    5: "#A0C056",
    6: "#9EBC5A",
    7: "#9CB85E",
    8: "#9AB462",
    9: "#98B066"
  },

  // Favored (8-9) - Green base with slight vulnerability adjustment
  8: {
    1: "#55B250",
    2: "#55B250",
    3: "#52AE4D",
    4: "#4FAA4A",
    5: "#4CA647",
    6: "#49A244",
    7: "#469E41",
    8: "#439A3E",
    9: "#40963B"
  },
  9: {
    1: "#55B250",
    2: "#55B250",
    3: "#52AE4D",
    4: "#4FAA4A",
    5: "#4CA647",
    6: "#49A244",
    7: "#469E41",
    8: "#439A3E",
    9: "#40963B"
  },

  // Very Favored (10) - Dark green with minimal vulnerability impact
  10: {
    1: "#025400",
    2: "#025400",
    3: "#025400",
    4: "#025000",
    5: "#024C00",
    6: "#024800",
    7: "#024400",
    8: "#024000",
    9: "#023C00"
  }
}

export function getBivariateColor(plantabilityScore: number, vulnerabilityScore: number): string {
  // Clamp values to valid ranges
  const plantability = Math.min(10, Math.max(0, plantabilityScore))
  const vulnerability = Math.min(9, Math.max(1, vulnerabilityScore))

  return PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[plantability]?.[vulnerability] || "#C4C4C4"
}

// Generate simplified MapLibre GL expression for bivariate mapping
export function generateBivariateColorExpression(): any[] {
  // Simplified approach using ranges instead of exact matches
  const expression: any[] = [
    "case",
    // Check if vulnerability field exists, if not just use plantability
    ["!=", ["get", "vulnerability_indice_day"], null],
    [
      "case",
      // Low vulnerability (1-3)
      ["<=", ["get", "vulnerability_indice_day"], 3],
      ["match", ["get", "indice"], ...PLANTABILITY_COLOR_MAP],

      // Medium vulnerability (4-6) - slightly warmer colors
      ["<=", ["get", "vulnerability_indice_day"], 6],
      [
        "case",
        ["<=", ["get", "indice"], 1],
        "#A8A8A8",
        ["<=", ["get", "indice"], 3],
        "#B85A1A",
        ["<=", ["get", "indice"], 5],
        "#D39D1C",
        ["<=", ["get", "indice"], 7],
        "#A2C452",
        ["<=", ["get", "indice"], 9],
        "#4FAA4A",
        "#025000"
      ],

      // High vulnerability (7-9) - warmer colors
      [
        "case",
        ["<=", ["get", "indice"], 1],
        "#A8A8A8",
        ["<=", ["get", "indice"], 3],
        "#B83632",
        ["<=", ["get", "indice"], 5],
        "#BA7530",
        ["<=", ["get", "indice"], 7],
        "#98B066",
        ["<=", ["get", "indice"], 9],
        "#40963B",
        "#023C00"
      ]
    ],
    // Fallback to plantability only
    ["match", ["get", "indice"], ...PLANTABILITY_COLOR_MAP]
  ]

  return expression
}
