import { PLANTABILITY_COLOR_MAP } from "./plantability"

export const PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP: {
  [plantability: number]: { [vulnerability: number]: string }
} = {
  0: {
    1: "#8A9BB5",
    2: "#9AABB0",
    3: "#A8A8A8",
    4: "#B8A090",
    5: "#C89080"
  },

  1: {
    1: "#8A7A56",
    2: "#A5824A",
    3: "#BF5A16",
    4: "#D44820",
    5: "#E03528"
  },

  2: {
    1: "#B8C844",
    2: "#CCBA38",
    3: "#DDAD14",
    4: "#E89520",
    5: "#F07830"
  },

  3: {
    1: "#7AB8AA",
    2: "#8FC458",
    3: "#A6CC4A",
    4: "#B8C050",
    5: "#C8A855"
  },

  4: {
    1: "#4A9B80",
    2: "#52A765",
    3: "#55B250",
    4: "#68B045",
    5: "#78A540"
  }
}

export function getBivariateColor(plantabilityScore: number, vulnerabilityScore: number): string {
  // Map plantability from 0-10 scale to 0-4 scale
  const plantability = Math.min(4, Math.max(0, Math.round(plantabilityScore / 2.5)))

  // Map vulnerability from 1-9 scale to 1-5 scale
  const vulnerability = Math.min(5, Math.max(1, Math.round(((vulnerabilityScore - 1) / 8) * 4) + 1))

  return PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[plantability]?.[vulnerability] || "#C4C4C4"
}

// Generate MapLibre GL expression using the bivariate colormap directly
export function generateBivariateColorExpression(): any[] {
  const expression: any[] = [
    "case",
    ["!=", ["get", "vulnerability_indice_day"], null],
    [
      "case",

      ["<=", ["get", "vulnerability_indice_day"], 2],
      [
        "case",
        ["<=", ["get", "indice"], 2],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[0][1],
        ["<=", ["get", "indice"], 4],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[1][1],
        ["<=", ["get", "indice"], 6],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[2][1],
        ["<=", ["get", "indice"], 8],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[3][1],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[4][1]
      ],

      ["<=", ["get", "vulnerability_indice_day"], 4],
      [
        "case",
        ["<=", ["get", "indice"], 2],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[0][2],
        ["<=", ["get", "indice"], 4],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[1][2],
        ["<=", ["get", "indice"], 6],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[2][2],
        ["<=", ["get", "indice"], 8],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[3][2],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[4][2]
      ],

      ["<=", ["get", "vulnerability_indice_day"], 6],
      [
        "case",
        ["<=", ["get", "indice"], 2],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[0][3],
        ["<=", ["get", "indice"], 4],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[1][3],
        ["<=", ["get", "indice"], 6],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[2][3],
        ["<=", ["get", "indice"], 8],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[3][3],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[4][3]
      ],

      ["<=", ["get", "vulnerability_indice_day"], 8],
      [
        "case",
        ["<=", ["get", "indice"], 2],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[0][4],
        ["<=", ["get", "indice"], 4],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[1][4],
        ["<=", ["get", "indice"], 6],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[2][4],
        ["<=", ["get", "indice"], 8],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[3][4],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[4][4]
      ],

      [
        "case",
        ["<=", ["get", "indice"], 2],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[0][5],
        ["<=", ["get", "indice"], 4],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[1][5],
        ["<=", ["get", "indice"], 6],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[2][5],
        ["<=", ["get", "indice"], 8],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[3][5],
        PLANT_VULNERABILITY_BIVARIATE_COLOR_MAP[4][5]
      ]
    ],

    ["match", ["get", "indice"], ...PLANTABILITY_COLOR_MAP]
  ]

  return expression
}
