import { computed, type Ref } from "vue"
import type {
  VulnerabilityFactor,
  VulnerabilityDetails,
  VulnerabilityData,
  ColorLegendItem
} from "@/types/vulnerability"

export const useVulnerability = (data: Ref<VulnerabilityData>) => {
  const factorsWithScores = computed((): VulnerabilityFactor[] => [
    {
      id: "surfaceBaties",
      label: "Nombre de surfaces bâties",
      dayScore: data.value.details.ExpoJourNoteDensBatiVol,
      nightScore: data.value.details.ExpoNuitNoteDensBatiVol
    },
    {
      id: "ventilation",
      label: "Ventilation de l'îlot",
      dayScore: null,
      nightScore: null
    },
    {
      id: "natureSol",
      label: "Nature du sol et écoulement de l'air",
      dayScore: null,
      nightScore: null
    },
    {
      id: "obstacleCiel",
      label: "Obstacle à la vue du ciel",
      dayScore: data.value.details.ExpoJourNoteSkyViewFactor,
      nightScore: data.value.details.ExpoNuitNoteSkyViewFactor
    },
    {
      id: "impermeabilisation",
      label: "Imperméabilisation des sols",
      dayScore: data.value.details.ExpoJourNotePermeabilite,
      nightScore: data.value.details.ExpoNuitNotePermeabilite
    },
    {
      id: "vegetationHaute",
      label: "Ombrage lié aux arbres",
      dayScore: data.value.details.ExpoJourNoteVegetationHaute,
      nightScore: null
    },
    {
      id: "presenceVegetation",
      label: "Présence/absence de végétation",
      dayScore: data.value.details.ExpoJourNoteVegetation,
      nightScore: data.value.details.ExpoNuitNoteVegetation
    },
    {
      id: "presenceEau",
      label: "Présence/absence d'eau",
      dayScore: data.value.details.ExpoJourNoteEau,
      nightScore: data.value.details.ExpoNuitNoteEau
    },
    {
      id: "proximiteForet",
      label: "Proximité de l'îlot à un bois une forêt",
      dayScore: data.value.details.ExpoJourNoteProxiForet,
      nightScore: data.value.details.ExpoNuitNoteProxiForet
    },
    {
      id: "proximiteEau",
      label: "Proximité de l'îlot à un cours d'eau ou un plan d'eau",
      dayScore: data.value.details.ExpoJourNoteProxiEau,
      nightScore: data.value.details.ExpoNuitNoteProxiEau
    },
    {
      id: "effusiviteThermique",
      label: "Effusivité thermique",
      dayScore: data.value.details.ExpoJourNoteEffusiviteThermique,
      nightScore: null
    },
    {
      id: "reflechissement",
      label: "Réfléchissement de la lumière",
      dayScore: data.value.details.ExpoJourNoteAlbedo,
      nightScore: null
    }
  ])

  const getScoreColor = (score: number, factorId: string): string => {
    switch (factorId) {
      case "surfaceBaties":
        if (score === 4) return "bg-red-500"
        if (score === 2) return "bg-orange-500"
        if (score === 0) return "bg-green-500"
        break

      case "obstacleCiel":
        if (score === 4 || score === 2) return "bg-red-500"
        if (score === 1) return "bg-orange-500"
        if (score === 0) return "bg-green-500"
        if (score === -2) return "bg-blue-400"
        break

      case "ruesEtroites":
        if (score >= 2) return "bg-red-500"
        if (score === 2) return "bg-orange-500"
        if (score === 0) return "bg-blue-400"
        if (score === -2) return "bg-blue-400"
        break

      case "vegetationHaute":
        if (score === -1) return "bg-blue-400"
        if (score === -2) return "bg-blue-700"
        break

      case "presenceVegetation":
        if (score === 1) return "bg-yellow-500"
        if (score === 0) return "bg-green-500"
        if (score === -1) return "bg-blue-400"
        if (score === -2) return "bg-blue-700"
        break

      case "presenceEau":
        if (score === 1) return "bg-yellow-500"
        if (score === 0) return "bg-green-500"
        if (score === -1) return "bg-blue-400"
        if (score === -2) return "bg-blue-700"
        break

      case "impermeabilisation":
        if (score === 3) return "bg-red-500"
        if (score === 2) return "bg-orange-500"
        if (score === -1) return "bg-blue-400"
        break

      case "effusiviteThermique":
        if (score === 4) return "bg-red-500"
        if (score === 2) return "bg-orange-500"
        if (score === 0) return "bg-green-500"
        break

      case "reflechissement":
        if (score === 2) return "bg-orange-500"
        if (score === 1) return "bg-yellow-500"
        if (score === -2) return "bg-blue-400"
        break

      case "proximiteForet":
        if (score === -1) return "bg-blue-400"
        if (score === 0) return "bg-gray-400"
        break

      case "proximiteEau":
        if (score === -1) return "bg-blue-400"
        if (score === 0) return "bg-gray-400"
        break
    }

    return "bg-gray-400"
  }

  const getScoreLabel = (score: number, factorId: string): string => {
    const color = getScoreColor(score, factorId)

    if (color.includes("red")) return "Fort"
    if (color.includes("orange")) return "Moyen"
    if (color.includes("yellow")) return "Faible"
    if (color.includes("green")) return "Neutre"
    if (color.includes("blue-400")) return "Effet de fraîcheur"
    if (color.includes("blue-700")) return "Effet de fraîcheur élevé"
    return "Aucun effet"
  }

  const colorLegend: ColorLegendItem[] = [
    { color: "bg-red-500", label: "Fort" },
    { color: "bg-orange-500", label: "Moyen" },
    { color: "bg-yellow-500", label: "Faible" },
    { color: "bg-green-500", label: "Neutre" },
    { color: "bg-blue-400", label: "Effet de fraîcheur" },
    { color: "bg-blue-700", label: "Effet de fraîcheur élevé" },
    { color: "bg-gray-400", label: "Aucun effet" }
  ]

  const getFactorDescription = (factorId: string): string => {
    const descriptions: Record<string, string> = {
      surfaceBaties:
        "La densité des surfaces bâties influence directement l'absorption et la rétention de chaleur dans l'environnement urbain.",
      ventilation:
        "La circulation de l'air permet d'évacuer la chaleur accumulée et de rafraîchir l'environnement urbain.",
      natureSol:
        "La nature du sol et sa capacité d'écoulement influencent l'accumulation d'humidité et la régulation thermique.",
      obstacleCiel:
        "Les obstacles réduisent la vue du ciel et limitent le refroidissement radiatif nocturne.",
      ruesEtroites:
        "Le rapport hauteur/largeur des rues influence la ventilation et l'ombrage urbain.",
      impermeabilisation:
        "Les surfaces imperméables empêchent l'évapotranspiration et augmentent le ruissellement.",
      vegetationHaute:
        "La végétation haute procure de l'ombrage et contribue au refroidissement par évapotranspiration.",
      presenceVegetation:
        "La végétation contribue au refroidissement par évapotranspiration et ombrage.",
      presenceEau: "Les surfaces en eau contribuent au refroidissement par évaporation.",
      reflechissement: "L'albédo des surfaces influence la réflexion de l'énergie solaire.",
      proximiteForet:
        "La proximité d'espaces boisés apporte des bénéfices de refroidissement par advection.",
      proximiteEau:
        "La proximité de cours d'eau ou plans d'eau contribue au refroidissement local.",
      effusiviteThermique:
        "L'effusivité thermique des matériaux influence leur capacité à absorber et restituer la chaleur."
    }

    return descriptions[factorId] || "Description non disponible."
  }

  return {
    factorsWithScores,
    getScoreColor,
    getScoreLabel,
    colorLegend,
    getFactorDescription
  }
}
