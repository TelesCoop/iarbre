<script lang="ts" setup>
import type { VulnerabilityData } from "@/types/vulnerability"
import { useVulnerability } from "@/composables/useVulnerabilityData"
import { toRef, computed, withDefaults } from "vue"
import ContextDataMainContainer from "@/components/contextData/shared/ContextDataMainContainer.vue"
import VulnerabilityContextDataList from "@/components/contextData/vulnerability/VulnerabilityContextDataList.vue"
import VulnerabilityContextDataLegend from "@/components/contextData/vulnerability/VulnerabilityContextDataLegend.vue"
import VulnerabilityMainContextDataScore from "@/components/contextData/vulnerability/VulnerabilityMainContextDataScore.vue"
import { useMapStore } from "@/stores/map"

const mapStore = useMapStore()
const zoomLevel = computed(() => mapStore.currentZoom)

interface VulnerabilityDataProps {
  data?: VulnerabilityData | null
  hideCloseButton?: boolean
  fullHeight?: boolean
}

const props = withDefaults(defineProps<VulnerabilityDataProps>(), {
  data: null
})

const currentData = computed<VulnerabilityData | null>(() => props.data)

const currentDataRef = toRef(() => currentData.value)

const { factorsWithScores, getScoreColor, getScoreLabel, colorLegend, getFactorDescription } =
  useVulnerability(currentDataRef)

const scorePercentageDay = computed(() =>
  currentData.value?.vulnerabilityIndexDay !== undefined
    ? (currentData.value.vulnerabilityIndexDay / 9) * 100
    : null
)

const scorePercentageNight = computed(() =>
  currentData.value?.vulnerabilityIndexNight !== undefined
    ? (currentData.value.vulnerabilityIndexNight / 9) * 100
    : null
)

// Detect if this is a multiple selection (ID starts with "polygon-")
const isMultipleSelection = computed(
  () => currentData.value?.id?.toString().startsWith("polygon-") || false
)

// Extract the number of zones from ID (format: "polygon-123")
const zoneCount = computed(() => {
  if (!isMultipleSelection.value) return 0
  const id = currentData.value?.id?.toString()
  const count = id?.split("-")[1]
  return count ? parseInt(count) : 0
})
</script>

<template>
  <context-data-main-container
    color-scheme="vulnerability"
    title="vulnerability"
    :description="
      isMultipleSelection
        ? `Moyenne de ${zoneCount} zones dans la sélection - Calcul basé sur l'exposition, la difficulté à faire face et la sensibilité.`
        : 'Calcul basé sur l\'exposition, la difficulté à faire face et la sensibilité.'
    "
    :data="currentData"
    :full-height="props.fullHeight"
    :hide-close-button="props.hideCloseButton"
    empty-message="Cliquez sur une zone."
    :zoom-level="zoomLevel"
  >
    <template #score="{ data: vulnerabilityData }">
      <div class="flex flex-col md:flex-row mb-4">
        <vulnerability-main-context-data-score
          v-if="scorePercentageDay !== null"
          class="flex-1"
          :percentage="scorePercentageDay"
          :score="vulnerabilityData.vulnerabilityIndexDay"
          name="Jour"
          data-cy="day-vulnerability-score"
        />
        <vulnerability-main-context-data-score
          v-if="scorePercentageNight !== null"
          class="flex-1"
          :percentage="scorePercentageNight"
          :score="vulnerabilityData.vulnerabilityIndexNight"
          name="Nuit"
          data-cy="night-vulnerability-score"
        />
      </div>
    </template>
    <template #content="{ data: vulnerabilityData, fullHeight: isFullHeight }">
      <vulnerability-context-data-list
        v-if="!mapStore.isShapeMode"
        :data="vulnerabilityData"
        :factors-with-scores="factorsWithScores"
        :get-factor-description="getFactorDescription"
        :get-score-color="getScoreColor"
        :get-score-label="getScoreLabel"
        :full-height="isFullHeight"
      />
    </template>
    <template #legend>
      <vulnerability-context-data-legend :color-legend="colorLegend" />
    </template>
  </context-data-main-container>
</template>
