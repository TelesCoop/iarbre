<script lang="ts" setup>
import type { VulnerabilityData } from "@/types/vulnerability"
import { useVulnerability } from "@/composables/useVulnerabilityData"
import { toRef, computed, withDefaults } from "vue"
import ContextDataMainContainer from "@/components/contextData/shared/ContextDataMainContainer.vue"
import VulnerabilityContextDataList from "@/components/contextData/vulnerability/VulnerabilityContextDataList.vue"
import VulnerabilityContextDataLegend from "@/components/contextData/vulnerability/VulnerabilityContextDataLegend.vue"
import VulnerabilityMainContextDataScore from "@/components/contextData/vulnerability/VulnerabilityMainContextDataScore.vue"

interface VulnerabilityDataProps {
  data?: VulnerabilityData | null
  hideCloseButton?: boolean
  fullHeight?: boolean
}

const props = withDefaults(defineProps<VulnerabilityDataProps>(), {
  data: null
})

const { factorsWithScores, getScoreColor, getScoreLabel, colorLegend, getFactorDescription } =
  useVulnerability(toRef(props, "data"))

const scorePercentageDay = computed(() =>
  props.data?.vulnerabilityIndexDay !== undefined
    ? (props.data.vulnerabilityIndexDay / 9) * 100
    : null
)

const scorePercentageNight = computed(() =>
  props.data?.vulnerabilityIndexNight !== undefined
    ? (props.data.vulnerabilityIndexNight / 9) * 100
    : null
)
</script>

<template>
  <context-data-main-container
    color-scheme="vulnerability"
    title="vulnerability"
    description="Calcul basé sur l'exposition, la difficulté à faire face et la sensibilité."
    :data="props.data"
    :full-height="props.fullHeight"
    :hide-close-button="props.hideCloseButton"
    empty-message="Cliquez sur une zone."
  >
    <template #score="{ data: vulnerabilityData }">
      <div class="flex flex-col md:flex-row">
        <vulnerability-main-context-data-score
          v-if="scorePercentageDay !== null"
          class="flex-1"
          :percentage="scorePercentageDay"
          :score="vulnerabilityData.vulnerabilityIndexDay"
          name="Jour"
          data-cy="day-vulnerability-score"
        />
        <vulnerability-main-context-data-score
          v-if="scorePercentageNight !== null"
          class="flex-1"
          :percentage="scorePercentageNight"
          :score="vulnerabilityData.vulnerabilityIndexNight"
          name="Nuit"
          data-cy="night-vulnerability-score"
        />
      </div>
    </template>
    <template #content="{ data: vulnerabilityData, fullHeight: isFullHeight }">
      <vulnerability-context-data-list
        :data="vulnerabilityData"
        :factors-with-scores="factorsWithScores"
        :get-factor-description="getFactorDescription"
        :get-score-color="getScoreColor"
        :get-score-label="getScoreLabel"
        :full-height="isFullHeight"
      />
    </template>
    <template #legend>
      <vulnerability-context-data-legend :color-legend="colorLegend" />
    </template>
  </context-data-main-container>
</template>
