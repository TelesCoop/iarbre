<script lang="ts" setup>
import type { VulnerabilityData } from "@/types/vulnerability"
import { useVulnerability } from "@/composables/useVulnerabilityData"
import { toRef, computed, withDefaults } from "vue"
import EmptyMessage from "@/components/EmptyMessage.vue"
import { DataType, DataTypeToLabel } from "@/utils/enum"

interface VulnerabilityDataProps {
  data?: VulnerabilityData | null
  hideCloseButton?: boolean
  fullHeight?: boolean
}

const props = withDefaults(defineProps<VulnerabilityDataProps>(), {
  data: null
})
const emit = defineEmits<{
  close: []
}>()

const handleClose = () => {
  emit("close")
}

const { factorsWithScores, getScoreColor, getScoreLabel, colorLegend, getFactorDescription } =
  useVulnerability(toRef(props, "data"))

const scorePercentage = computed(() =>
  props.data?.vulnerabilityIndexDay !== undefined
    ? (props.data.vulnerabilityIndexDay / 9) * 100
    : null
)
</script>

<template>
  <div
    aria-describedby="vulnerability-description"
    aria-labelledby="vulnerability-title"
    class="map-context-panel"
    role="dialog"
  >
    <map-context-header
      description="Calcul basé sur l'exposition, la sensibilité et la capacité d'adaptation"
      :title="DataTypeToLabel[DataType.VULNERABILITY]"
    />
    <div class="map-context-panel-content">
      <vulnerability-main-context-data-score
        v-if="props.data && scorePercentage !== null"
        :percentage="scorePercentage"
        :score="props.data.vulnerabilityIndexDay"
      />
      <empty-message v-else data-cy="empty-message" message="Zommez et cliquez sur un carreau" />
      <vulnerability-context-data-table
        v-if="props.data"
        :data="data"
        :factors-with-scores="factorsWithScores"
        :get-factor-description="getFactorDescription"
        :get-score-color="getScoreColor"
        :get-score-label="getScoreLabel"
        :full-height="props.fullHeight"
      />
      <vulnerability-context-data-legend :color-legend="colorLegend" />
    </div>
  </div>
</template>

<script lang="ts" setup></script>
