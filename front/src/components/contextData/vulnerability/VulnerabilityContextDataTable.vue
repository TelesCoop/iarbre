<script lang="ts" setup>
import { ref, computed } from "vue"
import type { VulnerabilityFactor, VulnerabilityData } from "@/types/vulnerability"
import VulnerabilityContextDataTableRow from "@/components/contextData/vulnerability/VulnerabilityContexDataTableRow.vue"
import {
  VulnerabilityCategory,
  VulnerabilityCategoryToIcon,
  VulnerabilityCategoryToDescription,
  VulnerabilityCategoryOrder
} from "@/utils/enum"
import VulnerabilityContextDataTableHeader from "@/components/contextData/vulnerability/VulnerabilityContextDataTableHeader.vue"
import { getSubVulnerabilityColor, VulnerabilityMode } from "@/utils/vulnerability"
import { useMapStore } from "@/stores/map"

const props = defineProps<{
  factorsWithScores: VulnerabilityFactor[]
  getScoreColor: (score: number, factorId: string) => string
  getScoreLabel: (score: number, factorId: string) => string
  getFactorDescription: (factorId: string) => string
  data: VulnerabilityData
}>()

const mapStore = useMapStore()

const expandedFactor = ref<string | null>(null)
const expandedCategories = ref<Record<VulnerabilityCategory, boolean>>({
  [VulnerabilityCategory.EXPOSITION]: true,
  [VulnerabilityCategory.CAPACITY_TO_FACE]: true,
  [VulnerabilityCategory.SENSIBILITY]: true
})

const toggleFactorInfo = (factorId: string) => {
  expandedFactor.value = expandedFactor.value === factorId ? null : factorId
}

const toggleCategory = (category: VulnerabilityCategory) => {
  expandedCategories.value[category] = !expandedCategories.value[category]
}

const factorsByCategory = computed(() => {
  const categories: Record<string, VulnerabilityFactor[]> = {}

  props.factorsWithScores.forEach((factor) => {
    if (!categories[factor.category]) {
      categories[factor.category] = []
    }
    categories[factor.category].push(factor)
  })

  return categories
})

const expositionScore = computed(() => {
  const mode = mapStore.vulnerabilityMode
  return mode === VulnerabilityMode.DAY ? props.data.expoIndexDay : props.data.expoIndexNight
})

const capacityScore = computed(() => {
  const mode = mapStore.vulnerabilityMode
  return mode === VulnerabilityMode.DAY ? props.data.capafIndexDay : props.data.capafIndexNight
})

const sensibilityScore = computed(() => {
  const mode = mapStore.vulnerabilityMode
  return mode === VulnerabilityMode.DAY
    ? props.data.sensibiltyIndexDay
    : props.data.sensibiltyIndexNight
})

const getCategoryScore = (category: VulnerabilityCategory): number | null => {
  const scores = {
    exposition: expositionScore.value,
    capacity: capacityScore.value,
    sensibility: sensibilityScore.value,
    mode: mapStore.vulnerabilityMode,
    data: props.data
  }

  switch (category) {
    case VulnerabilityCategory.EXPOSITION:
      return expositionScore.value ?? null
    case VulnerabilityCategory.CAPACITY_TO_FACE:
      return capacityScore.value ?? null
    case VulnerabilityCategory.SENSIBILITY:
      return sensibilityScore.value ?? null
    default:
      return null
  }
}
</script>

<template>
  <div
    class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden flex-1 min-h-0"
    data-cy="vulnerability-context-data-table"
  >
    <vulnerability-context-data-table-header />
    <div
      class="max-h-44 xs:max-h-48 sm:max-h-52 md:max-h-56 lg:max-h-56 xl:max-h-64 2xl:max-h-72 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"
    >
      <div
        v-for="category in VulnerabilityCategoryOrder"
        :key="category"
        class="border-b border-gray-100 last:border-b-0"
      >
        <div
          class="context-category-header py-3 font-medium text-sm text-gray-700 sticky top-0 z-10 border-b border-gray-200 shadow-sm"
          @click="toggleCategory(category)"
        >
          <div class="grid grid-cols-12 gap-1 sm:gap-3 px-2 sm:px-3 2xl:px-4 items-center">
            <div class="col-span-8 flex items-center gap-2">
              <svg
                :class="{ 'rotate-90': expandedCategories[category] }"
                class="w-4 h-4 transition-transform duration-200 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  clip-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  fill-rule="evenodd"
                />
              </svg>
              <span class="text-lg flex-shrink-0">{{ VulnerabilityCategoryToIcon[category] }}</span>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-800">{{ category }}</div>
                <div class="text-xs text-gray-500 mt-0.5">
                  {{ VulnerabilityCategoryToDescription[category] }}
                </div>
              </div>
            </div>
            <div class="col-span-4 flex justify-end items-center gap-2">
              <div
                v-if="getCategoryScore(category) !== null"
                :style="{
                  backgroundColor: getSubVulnerabilityColor(getCategoryScore(category) || 0)
                }"
                class="px-2 py-1 rounded text-white text-xs font-bold"
              >
                {{ getCategoryScore(category) }} / 3
              </div>
            </div>
          </div>
        </div>
        <div v-show="expandedCategories[category]" class="divide-y divide-gray-50">
          <vulnerability-context-data-table-row
            v-for="(factor, index) in factorsByCategory[category]"
            :key="factor.id"
            :factor="factor"
            :get-factor-description="getFactorDescription"
            :get-score-color="getScoreColor"
            :get-score-label="getScoreLabel"
            :index="index"
            @toggle-info="toggleFactorInfo"
          />
        </div>
      </div>
    </div>
  </div>
</template>
