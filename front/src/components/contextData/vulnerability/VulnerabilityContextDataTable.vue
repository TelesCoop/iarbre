<script lang="ts" setup>
import { ref, computed } from "vue"
import type { VulnerabilityFactor } from "@/types/vulnerability"
import VulnerabilityContextDataTableRow from "@/components/contextData/vulnerability/VulnerabilityContexDataTableRow.vue"

const props = defineProps<{
  factorsWithScores: VulnerabilityFactor[]
  getScoreColor: (score: number, factorId: string) => string
  getScoreLabel: (score: number, factorId: string) => string
  getFactorDescription: (factorId: string) => string
}>()

const expandedFactor = ref<string | null>(null)
const expandedCategories = ref<Record<string, boolean>>({
  Exposition: true,
  "Capacit√© √† faire face": true,
  Sensibilit√©: true
})

const toggleFactorInfo = (factorId: string) => {
  expandedFactor.value = expandedFactor.value === factorId ? null : factorId
}

const toggleCategory = (category: string) => {
  expandedCategories.value[category] = !expandedCategories.value[category]
}

const factorsByCategory = computed(() => {
  const categories: Record<string, VulnerabilityFactor[]> = {}

  props.factorsWithScores.forEach((factor) => {
    if (!categories[factor.category]) {
      categories[factor.category] = []
    }
    categories[factor.category].push(factor)
  })

  return categories
})

const categoryOrder = ["Exposition", "Capacit√© √† faire face", "Sensibilit√©"]

const categoryIcons: Record<string, string> = {
  Exposition: "üå°Ô∏è",
  "Capacit√© √† faire face": "üè•",
  Sensibilit√©: "üë•"
}

const categoryDescriptions: Record<string, string> = {
  Exposition: "Facteurs li√©s √† l'exposition √† la chaleur",
  "Capacit√© √† faire face": "Facteurs de capacit√© d'adaptation",
  Sensibilit√©: "Facteurs de sensibilit√© de la population"
}
</script>

<template>
  <div
    class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden flex-1 min-h-0"
    data-cy="vulnerability-context-data-table"
  >
    <vulnerability-context-data-table-header />
    <div
      class="max-h-44 xs:max-h-48 sm:max-h-52 md:max-h-56 lg:max-h-56 xl:max-h-64 2xl:max-h-72 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"
    >
      <div
        v-for="category in categoryOrder"
        :key="category"
        class="border-b border-gray-100 last:border-b-0"
      >
        <div
          class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 font-medium text-sm text-gray-700 sticky top-0 z-10 border-b border-gray-200 shadow-sm cursor-pointer hover:from-gray-100 hover:to-gray-200 transition-all duration-200"
          @click="toggleCategory(category)"
        >
          <div class="flex items-center gap-2">
            <svg
              :class="{ 'rotate-90': expandedCategories[category] }"
              class="w-4 h-4 transition-transform duration-200"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                clip-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                fill-rule="evenodd"
              />
            </svg>
            <span class="text-lg">{{ categoryIcons[category] }}</span>
            <div class="flex-1">
              <div class="font-semibold text-gray-800">{{ category }}</div>
              <div class="text-xs text-gray-500 mt-0.5">{{ categoryDescriptions[category] }}</div>
            </div>
            <span
              class="bg-white px-2 py-1 rounded-full text-xs font-medium text-gray-600 shadow-sm"
            >
              {{ factorsByCategory[category]?.length || 0 }}
            </span>
          </div>
        </div>
        <div v-show="expandedCategories[category]" class="divide-y divide-gray-50">
          <vulnerability-context-data-table-row
            v-for="(factor, index) in factorsByCategory[category]"
            :key="factor.id"
            :factor="factor"
            :get-factor-description="getFactorDescription"
            :get-score-color="getScoreColor"
            :get-score-label="getScoreLabel"
            :index="index"
            @toggle-info="toggleFactorInfo"
          />
        </div>
      </div>
    </div>
  </div>
</template>
