<script lang="ts" setup>
import { computed } from "vue"
import type { VulnerabilityData, VulnerabilityFactor } from "@/types/vulnerability"
import type { ContextDataVulnerabilityGroup } from "@/types/contextData"
import ContextDataListContainer from "@/components/contextData/shared/ContextDataListContainer.vue"
import {
  VulnerabilityCategory,
  VulnerabilityCategoryToIcon,
  VulnerabilityCategoryToDescription,
  VulnerabilityCategoryOrder
} from "@/utils/enum"
import { VulnerabilityMode } from "@/utils/vulnerability"
import { useMapStore } from "@/stores/map"

interface VulnerabilityListProps {
  factorsWithScores: VulnerabilityFactor[]
  getScoreColor: (score: number, factorId: string) => string
  getScoreLabel: (score: number, factorId: string) => string
  getFactorDescription: (factorId: string) => string
  data: VulnerabilityData
}

const props = defineProps<VulnerabilityListProps>()

const mapStore = useMapStore()

const factorsByCategory = computed(() => {
  const categories: Record<string, VulnerabilityFactor[]> = {}

  props.factorsWithScores.forEach((factor) => {
    if (!categories[factor.category]) {
      categories[factor.category] = []
    }
    categories[factor.category].push(factor)
  })

  return categories
})

const getScoresForMode = (mode: VulnerabilityMode) => {
  return {
    exposition:
      mode === VulnerabilityMode.DAY ? props.data.expoIndexDay : props.data.expoIndexNight,
    capacity:
      mode === VulnerabilityMode.DAY ? props.data.capafIndexDay : props.data.capafIndexNight,
    sensibility:
      mode === VulnerabilityMode.DAY
        ? props.data.sensibiltyIndexDay
        : props.data.sensibiltyIndexNight
  }
}

const getCategoryScore = (
  category: VulnerabilityCategory,
  mode?: VulnerabilityMode
): number | null => {
  const targetMode = mode || mapStore.vulnerabilityMode
  const modeScores = getScoresForMode(targetMode)

  switch (category) {
    case VulnerabilityCategory.EXPOSITION:
      return modeScores.exposition ?? null
    case VulnerabilityCategory.CAPACITY_TO_FACE:
      return modeScores.capacity ?? null
    case VulnerabilityCategory.SENSIBILITY:
      return modeScores.sensibility ?? null
    default:
      return null
  }
}

const vulnerabilityGroups = computed((): ContextDataVulnerabilityGroup[] => {
  return VulnerabilityCategoryOrder.map((category) => {
    const factors = (factorsByCategory.value[category] || []).map((factor) => ({
      key: factor.id,
      label: factor.label,
      value: "",
      icon: "",
      description: props.getFactorDescription(factor.id),
      dayScore: factor.dayScore,
      nightScore: factor.nightScore,
      factorId: factor.id
    }))

    return {
      category: category,
      label: category,
      icon: VulnerabilityCategoryToIcon[category],
      description: VulnerabilityCategoryToDescription[category],
      factors
    }
  })
})
</script>

<template>
  <context-data-list-container
    :groups="vulnerabilityGroups"
    color-scheme="vulnerability"
    :get-category-score="getCategoryScore"
    :get-score-color="getScoreColor"
    :get-score-label="getScoreLabel"
    aria-label="Liste des facteurs de vulnérabilité par catégorie"
  />
</template>
