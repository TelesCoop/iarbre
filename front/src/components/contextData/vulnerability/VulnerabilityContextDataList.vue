<script lang="ts" setup>
import { computed, ref } from "vue"
import type { VulnerabilityData, VulnerabilityFactor } from "@/types/vulnerability"
import type { ContextDataVulnerabilityGroup } from "@/types/contextData"
import ContextDataAccordionItem from "@/components/contextData/shared/ContextDataAccordionItem.vue"
import VulnerabilityContextDataScoreBadge from "@/components/contextData/vulnerability/VulnerabilityContextDataScoreBadge.vue"
import VulnerabilityContextDataScore from "@/components/contextData/vulnerability/VulnerabilityContextDataScore.vue"
import {
  VulnerabilityCategory,
  VulnerabilityCategoryToIcon,
  VulnerabilityCategoryToDescription,
  VulnerabilityCategoryOrder
} from "@/utils/enum"
import { VulnerabilityMode } from "@/utils/vulnerability"
import { useMapStore } from "@/stores/map"

interface VulnerabilityListProps {
  factorsWithScores: VulnerabilityFactor[]
  getScoreColor: (score: number, factorId: string) => string
  getScoreLabel: (score: number, factorId: string) => string
  getFactorDescription: (factorId: string) => string
  data: VulnerabilityData
  fullHeight?: boolean
}

const props = defineProps<VulnerabilityListProps>()

const mapStore = useMapStore()

const factorsByCategory = computed(() => {
  const categories: Record<string, VulnerabilityFactor[]> = {}

  props.factorsWithScores.forEach((factor) => {
    if (!categories[factor.category]) {
      categories[factor.category] = []
    }
    categories[factor.category].push(factor)
  })

  return categories
})

const getScoresForMode = (mode: VulnerabilityMode) => {
  return {
    exposition:
      mode === VulnerabilityMode.DAY ? props.data.expoIndexDay : props.data.expoIndexNight,
    capacity:
      mode === VulnerabilityMode.DAY ? props.data.capafIndexDay : props.data.capafIndexNight,
    sensibility:
      mode === VulnerabilityMode.DAY
        ? props.data.sensibiltyIndexDay
        : props.data.sensibiltyIndexNight
  }
}

const getCategoryScore = (
  category: VulnerabilityCategory,
  mode?: VulnerabilityMode
): number | null => {
  const targetMode = mode || mapStore.vulnerabilityMode
  const modeScores = getScoresForMode(targetMode)

  switch (category) {
    case VulnerabilityCategory.EXPOSITION:
      return modeScores.exposition ?? null
    case VulnerabilityCategory.CAPACITY_TO_FACE:
      return modeScores.capacity ?? null
    case VulnerabilityCategory.SENSIBILITY:
      return modeScores.sensibility ?? null
    default:
      return null
  }
}

const vulnerabilityGroups = computed((): ContextDataVulnerabilityGroup[] => {
  return VulnerabilityCategoryOrder.map((category) => {
    const factors = (factorsByCategory.value[category] || []).map((factor) => ({
      key: factor.id,
      label: factor.label,
      value: "",
      icon: "",
      impact: null,
      description: props.getFactorDescription(factor.id),
      dayScore: factor.dayScore,
      nightScore: factor.nightScore,
      factorId: factor.id
    }))

    return {
      category: category,
      label: category,
      icon: VulnerabilityCategoryToIcon[category],
      description: VulnerabilityCategoryToDescription[category],
      factors,
      categoryScores: {
        day: getCategoryScore(category, VulnerabilityMode.DAY),
        night: getCategoryScore(category, VulnerabilityMode.NIGHT)
      }
    }
  })
})
</script>

<template>
  <div class="space-y-3 pr-2" role="list">
    <div v-for="group in vulnerabilityGroups" :key="group.category" class="mb-2">
      <button
        class="flex items-center justify-between w-full p-3 text-left bg-gray-50 hover:bg-gray-100 focus:bg-gray-100 transition-colors cursor-pointer rounded-r-lg border-l-4 border-l-primary-500"
        :aria-controls="`category-${group.category}`"
        :data-cy="`category-${group.category}`"
      >
        <div class="flex items-center gap-3">
          <span class="text-lg">{{ group.icon }}</span>
          <div class="flex-1">
            <h4 class="text-sm font-medium text-gray-900">
              {{ group.label }}
            </h4>
            <p class="text-xs text-gray-600">
              {{ group.description }}
            </p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <vulnerability-context-data-score-badge
            :category="group.category as VulnerabilityCategory"
            :get-category-score="getCategoryScore"
          />
          <i class="pi pi-chevron-down transition-transform duration-200" aria-hidden="true"></i>
        </div>
      </button>

      <div :id="`category-${group.category}`" class="mt-2 ml-4 space-y-2">
        <div
          v-for="factor in group.factors"
          :key="factor.key"
          class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 focus-within:bg-gray-100 transition-colors"
          role="listitem"
          :data-cy="`factor-${factor.key}`"
        >
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-2">
              <h4 class="text-sm font-medium text-gray-900 mb-1 truncate">
                {{ factor.label }}
              </h4>
              <button
                v-if="factor.description"
                class="text-gray-400 hover:text-blue-600 transition-colors opacity-60 hover:opacity-100 flex-shrink-0 p-1 rounded-full hover:bg-primary-100"
              >
                <svg
                  v-tooltip.top="factor.description"
                  class="w-3 h-3 sm:w-4 sm:h-4"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    clip-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                    fill-rule="evenodd"
                  />
                </svg>
              </button>
            </div>

            <div class="flex gap-6">
              <div class="flex items-center gap-2">
                <span class="text-xs font-medium text-gray-600">‚òÄÔ∏è Jour:</span>
                <vulnerability-context-data-score
                  :data-cy="`day-score-${factor.key}`"
                  :factor-id="factor.factorId || factor.key"
                  :get-score-color="getScoreColor"
                  :get-score-label="getScoreLabel"
                  :score="factor.dayScore ?? null"
                />
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs font-medium text-gray-600">üåô Nuit:</span>
                <vulnerability-context-data-score
                  :data-cy="`night-score-${factor.key}`"
                  :factor-id="factor.factorId || factor.key"
                  :get-score-color="getScoreColor"
                  :get-score-label="getScoreLabel"
                  :score="factor.nightScore ?? null"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
