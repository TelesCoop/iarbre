<script lang="ts" setup>
import type { MapScorePopupData } from "@/types/map"
import { computed } from "vue"
import {
  getVulnerabilityColor,
  getVulnerabilityDesc,
  getVulnerabilityScoreLabel,
  VulnerabilityMode,
  vulnerabilityScore,
  VulnerabilityType
} from "@/utils/vulnerability"
import { useMapStore } from "@/stores/map"

const props = defineProps({
  popupData: {
    required: true,
    type: Object as () => MapScorePopupData
  }
})
const mapStore = useMapStore()
const score = computed(() => props.popupData.properties[`indice_${mapStore.vulnerabilityMode}`])
const expositionScore = computed(
  () => props.popupData.properties[`expo_index_${mapStore.vulnerabilityMode}`]
)
const difficultyScore = computed(
  () => props.popupData.properties[`capaf_index_${mapStore.vulnerabilityMode}`]
)
const sensibilityScore = computed(
  () => props.popupData.properties[`sensibilty_index_${mapStore.vulnerabilityMode}`]
)
const backgroundColor = computed(() => getVulnerabilityColor(score.value))
</script>
<template>
  <div data-cy="vulnerability-score-popup">
    <div class="flex items-center gap-2 w-11/12 mb-2">
      <score-tag
        :score="score"
        :background-color="backgroundColor"
        :total="vulnerabilityScore['TOTAL']"
        custom-size-class="w-32 h-12 p-2 text-xl"
      />

      <span class="font-accent text-base" data-cy="vulnerability-score-popup-title"
        >Vulnérabilité {{ getVulnerabilityDesc(score) }} aux fortes chaleurs
        {{ mapStore.vulnerabilityMode === VulnerabilityMode.DAY ? "en journée" : "la nuit" }}
      </span>
    </div>
    <div class="w-full text-sm">
      <div class="flex flex-col gap-1 text-md">
        <vulnerability-score-popup-item
          :label="getVulnerabilityScoreLabel[VulnerabilityType.EXPOSITION]"
          :score="expositionScore"
          :total="vulnerabilityScore[VulnerabilityType.EXPOSITION]"
        />
        <vulnerability-score-popup-item
          :label="getVulnerabilityScoreLabel[VulnerabilityType.SENSIBILITY]"
          :score="sensibilityScore"
          :total="vulnerabilityScore[VulnerabilityType.SENSIBILITY]"
        />
        <vulnerability-score-popup-item
          :label="getVulnerabilityScoreLabel[VulnerabilityType.DIFFICULTY_TO_FACE]"
          :score="difficultyScore"
          :total="vulnerabilityScore[VulnerabilityType.DIFFICULTY_TO_FACE]"
        />
      </div>
    </div>
    <div class="flex w-full items-center justify-center">
      <show-hide-score-button
        :feature-id="popupData.id"
        data-cy="toggle-vulnerability-score-details"
      />
    </div>
  </div>
</template>
