<script lang="ts" setup>
import { useMapStore } from "@/stores/map"
import { PLANTABILITY_VULNERABILITY_BIVARIATE_COLOR_MAP } from "@/utils/plantability_vulnerability"
import BivariateCellLabel from "../score/BivariateCellLabel.vue"

const mapStore = useMapStore()

const plantabilityValues = [0, 1, 2, 3, 4] // 0=Impossible, 1=Constrained, 2=Neutral, 3=Favored, 4=Very Favored
const vulnerabilityValues = [1, 2, 3, 4, 5] // 1=Very Low, 2=Low, 3=Medium, 4=High, 5=Very High

const createSquareGrid = () => {
  const grid = []

  for (let v = 4; v >= 0; v--) {
    // vulnerability rows (top to bottom: high to low)
    const row = []
    for (let p = 0; p <= 4; p++) {
      // plantability columns (left to right: low to high)
      row.push({
        plantability: plantabilityValues[p],
        vulnerability: vulnerabilityValues[v],
        color:
          PLANTABILITY_VULNERABILITY_BIVARIATE_COLOR_MAP[plantabilityValues[p]][
            vulnerabilityValues[v]
          ],
        id: `${plantabilityValues[p]}-${vulnerabilityValues[v]}`
      })
    }
    grid.push(row)
  }

  return grid
}

const squareGrid = createSquareGrid()

const isCellHighlighted = (plantability: number, vulnerability: number) => {
  const selected = mapStore.selectedLegendCell
  return Boolean(
    selected && selected.plantability === plantability && selected.vulnerability === vulnerability
  )
}
</script>

<template>
  <div class="bivariate-legend" data-cy="plant-vulnerability-legend">
    <div class="legend-header">
      <span class="legend-title">Plantabilité × Vulnérabilité</span>
    </div>
    <div class="legend-grid-container">
      <div class="axis-label axis-y">
        <span class="axis-indicator">+</span>
        <span class="axis-text">Vulnérabilité</span>
        <span class="axis-indicator">−</span>
      </div>
      <div class="axis-label axis-x">
        <span class="axis-indicator">−</span>
        <span class="axis-text">Plantabilité</span>
        <span class="axis-indicator">+</span>
      </div>
      <div class="legend-grid">
        <template v-for="(row, rowIndex) in squareGrid" :key="`row-${rowIndex}`">
          <BivariateCellLabel
            v-for="(cell, cellIndex) in row"
            :key="`cell-${rowIndex}-${cellIndex}`"
            :clickable="false"
            :color="cell.color"
            :highlighted="isCellHighlighted(cellIndex, rowIndex)"
            :plantability="cell.plantability"
            :vulnerability="cell.vulnerability"
          />
        </template>
      </div>
    </div>
  </div>
</template>

<style scoped>
@reference "@/styles/main.css";

.bivariate-legend {
  @apply flex flex-col items-center gap-2 font-sans overflow-visible;
}

.legend-header {
  @apply flex items-center justify-center;
}

.legend-title {
  @apply text-xs font-medium text-gray-500 uppercase tracking-wide;
}

.legend-grid-container {
  @apply relative pt-5 pr-4 pb-2 pl-5;
}

.axis-label {
  @apply absolute flex items-center gap-1 text-xs text-gray-500 whitespace-nowrap;
}

.axis-y {
  @apply -left-10 top-1/2 -translate-y-1/2 -rotate-90 origin-center;
}

.axis-x {
  @apply top-0 left-1/2 -translate-x-1/2;
}

.axis-indicator {
  @apply font-bold text-xs text-gray-400;
}

.axis-text {
  @apply text-xs;
}

.legend-grid {
  @apply grid grid-cols-5 gap-1 p-2 rounded;
}
</style>
