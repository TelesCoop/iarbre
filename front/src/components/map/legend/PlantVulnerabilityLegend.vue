<script lang="ts" setup>
import { useMapStore } from "@/stores/map"
import { getBivariateColor } from "@/utils/plant_vulnerability"
import BivariateCellLabel from "../score/BivariateCellLabel.vue"

const mapStore = useMapStore()

const plantabilityValues = [0, 1, 2, 3, 4] // 0=Impossible, 1=Constrained, 2=Neutral, 3=Favored, 4=Very Favored
const vulnerabilityValues = [1, 2, 3, 4, 5] // 1=Very Low, 2=Low, 3=Medium, 4=High, 5=Very High

const createSquareGrid = () => {
  const grid = []

  for (let v = 4; v >= 0; v--) {
    // vulnerability rows (top to bottom: high to low)
    const row = []
    for (let p = 0; p <= 4; p++) {
      // plantability columns (left to right: low to high)
      row.push({
        plantability: plantabilityValues[p],
        vulnerability: vulnerabilityValues[v],
        color: getBivariateColor(plantabilityValues[p] * 2.5, vulnerabilityValues[v] * 2 - 1),
        id: `${plantabilityValues[p]}-${vulnerabilityValues[v]}`
      })
    }
    grid.push(row)
  }

  return grid
}

const squareGrid = createSquareGrid()

const handleScoreClick = (plantability: number, vulnerability: number) => {
  const bivariateId = `${plantability}-${vulnerability}`
  mapStore.toggleAndApplyFilter(bivariateId)
}
</script>

<template>
  <div class="font-accent text-xs leading-3 overflow-visible" data-cy="plant-vulnerability-legend">
    <div class="flex flex-col items-center p-8">
      <div class="flex items-center justify-center mb-2">
        <div class="text-sm opacity-75 transform -rotate-45 origin-center">- Plantabilité +</div>
        <div class="text-sm opacity-75 transform rotate-45 origin-center">- Vulnérabilité +</div>
      </div>
      <div class="relative">
        <div class="transform rotate-45 grid grid-cols-5 gap-1 p-2">
          <template v-for="(row, rowIndex) in squareGrid" :key="`row-${rowIndex}`">
            <bivariate-cell-label
              v-for="(cell, cellIndex) in row"
              :key="`cell-${rowIndex}-${cellIndex}`"
              :plantability="cell.plantability"
              :vulnerability="cell.vulnerability"
              :color="cell.color"
              :clickable="true"
              :is-selected="mapStore.isFiltered(cell.id)"
              @click="() => handleScoreClick(cell.plantability, cell.vulnerability)"
            />
          </template>
        </div>
      </div>
    </div>
  </div>
</template>
