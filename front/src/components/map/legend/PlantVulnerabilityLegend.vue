<script lang="ts" setup>
import { useMapStore } from "@/stores/map"
import { PLANTABILITY_VULNERABILITY_BIVARIATE_COLOR_MAP } from "@/utils/plantability_vulnerability"
import BivariateCellLabel from "../score/BivariateCellLabel.vue"

const mapStore = useMapStore()

const plantabilityValues = [0, 1, 2, 3, 4] // 0=Impossible, 1=Constrained, 2=Neutral, 3=Favored, 4=Very Favored
const vulnerabilityValues = [1, 2, 3, 4, 5] // 1=Very Low, 2=Low, 3=Medium, 4=High, 5=Very High

const createSquareGrid = () => {
  const grid = []

  for (let v = 4; v >= 0; v--) {
    // vulnerability rows (top to bottom: high to low)
    const row = []
    for (let p = 0; p <= 4; p++) {
      // plantability columns (left to right: low to high)
      row.push({
        plantability: plantabilityValues[p],
        vulnerability: vulnerabilityValues[v],
        color:
          PLANTABILITY_VULNERABILITY_BIVARIATE_COLOR_MAP[plantabilityValues[p]][
            vulnerabilityValues[v]
          ],
        id: `${plantabilityValues[p]}-${vulnerabilityValues[v]}`
      })
    }
    grid.push(row)
  }

  return grid
}

const squareGrid = createSquareGrid()

const isCellHighlighted = (plantability: number, vulnerability: number) => {
  const selected = mapStore.selectedLegendCell
  return Boolean(
    selected && selected.plantability === plantability && selected.vulnerability === vulnerability
  )
}

const handleCellClick = (plantability: number, vulnerability: number) => {
  const cellId = `${plantability}-${vulnerability}`
  mapStore.toggleAndApplyFilter(cellId)
}
</script>

<template>
  <div class="font-accent text-xs leading-3 overflow-visible" data-cy="plant-vulnerability-legend">
    <div class="flex flex-col items-center p-4">
      <div class="relative">
        <div class="absolute -left-18 top-1/2 transform -translate-y-1/2 -rotate-90">
          <div class="text-xs opacity-75 whitespace-nowrap">
            <span class="mr-1">+</span>Vulnérabilité<span class="ml-1">−</span>
          </div>
        </div>
        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
          <div class="text-xs opacity-75 whitespace-nowrap">
            <span class="mr-1">−</span>Plantabilité<span class="ml-1">+</span>
          </div>
        </div>

        <div class="transform grid grid-cols-5 gap-1 p-2">
          <template v-for="(row, rowIndex) in squareGrid" :key="`row-${rowIndex}`">
            <bivariate-cell-label
              v-for="(cell, cellIndex) in row"
              :key="`cell-${rowIndex}-${cellIndex}`"
              :plantability="cell.plantability"
              :vulnerability="cell.vulnerability"
              :color="cell.color"
              :clickable="true"
              :highlighted="isCellHighlighted(cell.plantability, cell.vulnerability)"
              @click="handleCellClick(cell.plantability, cell.vulnerability)"
            />
          </template>
        </div>
      </div>
    </div>
  </div>
</template>
