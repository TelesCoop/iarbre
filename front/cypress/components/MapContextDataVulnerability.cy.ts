import { createPinia } from "pinia"
import { mount } from "cypress/vue"
import MapContextDataVulnerability from "@/components/contextData/MapContextDataVulnerability.vue"
import { DataType, GeoLevel } from "@/utils/enum"
import type { VulnerabilityData } from "@/types/vulnerability"

const VULNERABILITY_FACTORS = [
  "Nombre de surfaces bâties",
  "Obstacle à la vue du ciel",
  "Nature du sol et écoulement de l'air",
  "Obstacle à la vue du ciel"
]

const SCORE_TEST_CASES = [
  { factor: "surfaceBaties", day: 4, night: 2 },
  { factor: "obstacleCiel", day: 2, night: 1 },
  { factor: "impermeabilisation", day: 3, night: 2 },
  { factor: "vegetationHaute", day: -2, night: null },
  { factor: "presenceVegetation", day: -1, night: 0 },
  { factor: "presenceEau", day: -1, night: -2 }
]

const checkScore = (period, factor, score) => {
  const selector = `${period}-score-${factor}`

  if (score === null) {
    cy.getBySel(selector).should("not.contain", `[data-cy^="vulnerability-context-data-"]`)
  } else {
    cy.getBySel(selector).find(`[data-cy="vulnerability-context-data-${score}"]`).should("exist")
  }
}

const verifyFactorsVisibility = () => {
  VULNERABILITY_FACTORS.forEach((factor) => {
    cy.contains(factor).should("be.visible")
  })
}

const verifyScores = () => {
  SCORE_TEST_CASES.forEach(({ factor, day, night }) => {
    checkScore("day", factor, day)
    checkScore("night", factor, night)
  })
}

describe("MapContextDataVulnerability", () => {
  const mockVulnerabilityData: VulnerabilityData = {
    capafIndexDay: 5,
    capafIndexNight: 6,
    expoIndexDay: 7,
    expoIndexNight: 8,
    sensibiltyIndexDay: 4,
    sensibiltyIndexNight: 3,
    vulnerabilityIndexDay: 6,
    vulnerabilityIndexNight: 7,
    datatype: DataType.VULNERABILITY,
    geolevel: GeoLevel.LCZ,
    id: 123,
    geometry: "POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))",
    mapGeometry: "POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))",
    details: {
      CapafJourNoteAccesurgences: 5,
      CapafJourNoteMenpauv: 6,
      CapafJourNoteOffremed: 7,
      CapafJourNoteProxiespacevert: 8,
      CapafJourNoteVegetationHaute: 9,
      CapafNuitNoteAccesurgences: 4,
      CapafNuitNoteMenpauv: 5,
      CapafNuitNoteProxiespacevert: 6,
      CapafNuitNoteVegetationHaute: 7,
      ExpoJourNoteAlbedo: 2,
      ExpoJourNoteCanyon: 4,
      ExpoJourNoteDensBatiVol: 4,
      ExpoJourNoteEau: -1,
      ExpoJourNoteEffusiviteThermique: 4,
      ExpoJourNotePermeabilite: 3,
      ExpoJourNoteProxiEau: -1,
      ExpoJourNoteProxiForet: -1,
      ExpoJourNoteSkyViewFactor: 2,
      ExpoJourNoteVegetation: -1,
      ExpoJourNoteVegetationHaute: -2,
      ExpoNuitNoteCanyon: 2,
      ExpoNuitNoteDensBatiVol: 2,
      ExpoNuitNoteEau: -2,
      ExpoNuitNotePermeabilite: 2,
      ExpoNuitNoteProxiEau: -1,
      ExpoNuitNoteProxiForet: 0,
      ExpoNuitNoteSkyViewFactor: 1,
      ExpoNuitNoteVegetation: 0,
      LCZLibellé: "Compact mid-rise",
      LCZ_PRIMARY: 2,
      SensiJourNoteDensiteEmploi: 5,
      SensiJourNoteDensitéHab: 6,
      SensiJourNoteDensitéOccupationLogement: 7,
      SensiJourNoteIncofortHabitat: 8,
      SensiJourNotePartMenage1ind: 9,
      SensiJourNotePopulationSensible_âge: 1,
      SensiJourNoteQualitéAir: 2,
      SensiNuitNoteDensitéHab: 3,
      SensiNuitNoteDensitéOccupationLogement: 4,
      SensiNuitNoteIncofortHabitat: 5,
      SensiNuitNotePartMenage1ind: 6,
      SensiNuitNotePopulationSensible_âge: 7,
      SensiNuitNoteQualitéAir: 8,
      Surface_RSUDetails: 1000,
      codeinsee: "69001"
    }
  }

  const mockEmptyVulnerabilityData: VulnerabilityData = {
    ...mockVulnerabilityData,
    details: null
  }

  beforeEach(() => {
    cy.viewport(1024, 768)
  })

  it("display vulnerability data correctly", () => {
    const pinia = createPinia()

    mount(MapContextDataVulnerability, {
      global: {
        plugins: [pinia]
      },
      props: {
        data: mockVulnerabilityData
      }
    })

    cy.contains("Vulnérabilité à la chaleur").should("be.visible")
    cy.get('[data-cy="vulnerability-context-data-table"]').should("be.visible")
    cy.get('[data-cy="vulnerability-context-data-legend"]').should("be.visible")
  })

  it("display empty message when no data is available", () => {
    const pinia = createPinia()

    mount(MapContextDataVulnerability, {
      global: {
        plugins: [pinia]
      },
      props: {
        data: mockEmptyVulnerabilityData
      }
    })

    cy.get('[data-cy="empty-message"]').should("be.visible")
    cy.contains("Aucune donnée connue").should("be.visible")
  })

  it("display vulnerability factors with correct scores", () => {
    const pinia = createPinia()

    mount(MapContextDataVulnerability, {
      global: {
        plugins: [pinia]
      },
      props: {
        data: mockVulnerabilityData
      }
    })
    cy.get('[data-cy="vulnerability-context-data-table"]').within(() => {
      verifyFactorsVisibility()
      verifyScores()
    })
  })

  it("display legend with color indicators", () => {
    const pinia = createPinia()

    mount(MapContextDataVulnerability, {
      global: {
        plugins: [pinia]
      },
      props: {
        data: mockVulnerabilityData
      }
    })

    cy.get('[data-cy="vulnerability-context-data-legend"]').should("be.visible")
    cy.get('[data-cy="vulnerability-context-data-legend"]').within(() => {
      cy.contains("Fort").should("be.visible")
      cy.contains("Moyen").should("be.visible")
      cy.contains("Faible").should("be.visible")
      cy.contains("Neutre").should("be.visible")
      cy.contains("Effet de fraîcheur").should("be.visible")
      cy.contains("Aucun effet").should("be.visible")
    })
  })
})
